#!/bin/bash
#SBATCH --partition=gpu_h100
#SBATCH --gpus=1
#SBATCH --job-name=full_evaluation
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=05:00:00
#SBATCH --chdir=/home/scur1687/raptor_clean
#SBATCH --output=/home/scur1687/raptor_clean/logs/out-%x.%A.out
#SBATCH --error=/home/scur1687/raptor_clean/logs/err-%x.%A.err

set -euo pipefail

# --- Modules & Conda env ---
module purge
module load 2023
module load Anaconda3/2023.07-2

# Robust conda activation in non-interactive shells
eval "$(conda shell.bash hook)"
conda activate raptor_env

# --- Make repo importable as 'raptor' (safe with set -u) ---
export PYTHONPATH="/home/scur1687/raptor_clean:${PYTHONPATH:-}"

export HF_HOME="$HOME/.cache/huggingface"
export TRANSFORMERS_CACHE="$HF_HOME/transformers"
export NLTK_DATA="$HOME/.cache/nltk"
export TORCH_HOME="$HOME/.cache/torch"


export OPENAI_API_KEY="""

# Sanity check
python - <<'PY'
import os, sys
print("CWD:", os.getcwd())
print("Top of sys.path:", sys.path[:3])
import raptor
print("raptor import OK from:", raptor.__file__)
PY


SCRIPT=evaluation/eval_umaps.py  
OUT=results/table_runs.jsonl

# Dataset split JSONLs
NQA_SPLIT=data/processed/narrativeqa/eval_val_sub50_q5.jsonl
QUALITY_SPLIT=data/processed/quality/eval_val_sub50_q5.jsonl
QASPER_SPLIT=data/processed/qasper/eval_val_sub50_q5.jsonl

# Seeds
SEEDS="224 42 99"

# --------- RUNS: RAPTOR (with tree) ---------
# 1) RAPTOR + UMAP
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --with-raptor --seeds $SEEDS --dr-method umap   --clusterer raptor --run-name raptor_umap   --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --with-raptor --seeds $SEEDS --dr-method umap   --clusterer raptor --run-name raptor_umap   --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --with-raptor --seeds $SEEDS --dr-method umap   --clusterer raptor --run-name raptor_umap   --out $OUT

# 2) RAPTOR + TriMAP
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --with-raptor --seeds $SEEDS --dr-method trimap --clusterer raptor --run-name raptor_trimap --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --with-raptor --seeds $SEEDS --dr-method trimap --clusterer raptor --run-name raptor_trimap --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --with-raptor --seeds $SEEDS --dr-method trimap --clusterer raptor --run-name raptor_trimap --out $OUT

# 3) RAPTOR + PaCMAP
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --with-raptor --seeds $SEEDS --dr-method pacmap --clusterer raptor --run-name raptor_pacmap --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --with-raptor --seeds $SEEDS --dr-method pacmap --clusterer raptor --run-name raptor_pacmap --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --with-raptor --seeds $SEEDS --dr-method pacmap --clusterer raptor --run-name raptor_pacmap --out $OUT

# 4) HDBSCAN + UMAP
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --with-raptor --seeds $SEEDS --dr-method umap   --clusterer hdbscan --run-name hdbscan_umap --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --with-raptor --seeds $SEEDS --dr-method umap   --clusterer hdbscan --run-name hdbscan_umap --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --with-raptor --seeds $SEEDS --dr-method umap   --clusterer hdbscan --run-name hdbscan_umap --out $OUT

# 5) HDBSCAN + NONE (no dimensionality reduction)
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --with-raptor --seeds $SEEDS --dr-method none   --clusterer hdbscan --run-name hdbscan_none --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --with-raptor --seeds $SEEDS --dr-method none   --clusterer hdbscan --run-name hdbscan_none --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --with-raptor --seeds $SEEDS --dr-method none   --clusterer hdbscan --run-name hdbscan_none --out $OUT

# --------- Baseline (no tree) ----------
python $SCRIPT --dataset narrativeqa --split $NQA_SPLIT    --no-with-raptor --seeds $SEEDS --run-name baseline_sbert --out $OUT
python $SCRIPT --dataset quality     --split $QUALITY_SPLIT --no-with-raptor --seeds $SEEDS --run-name baseline_sbert --out $OUT
python $SCRIPT --dataset qasper      --split $QASPER_SPLIT  --no-with-raptor --seeds $SEEDS --run-name baseline_sbert --out $OUT
